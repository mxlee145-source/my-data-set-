<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—°êµ¬ìš© ìˆ˜ì‹ ì‹œíŠ¸ (ë³´ì •íŒ)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; color: #1a3a5f; }
        .status { font-size: 0.9em; padding: 5px 10px; border-radius: 4px; font-weight: bold; }
        .status.saved { background-color: #e8f5e9; color: #2e7d32; }
        .status.unsaved { background-color: #ffebee; color: #c62828; }
        .controls { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
        button { padding: 8px 16px; cursor: pointer; border: none; border-radius: 6px; font-weight: 500; }
        .btn-save { background: #2980b9; color: white; }
        #spreadsheet { width: 100%; height: 500px; overflow: hidden; border: 1px solid #ddd; }
        .summary-row { background-color: #f9f9f9 !important; font-weight: bold; color: #d35400; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ“Š ìˆ˜ì‹ ìë™ê³„ì‚° ì‹œíŠ¸</h2>
        <div id="save-status" class="status saved">ì¤€ë¹„ë¨</div>
    </div>
    
    <div class="controls">
        <button class="btn-save" onclick="saveToLocalStorage()">ì €ì¥ (Ctrl + S)</button>
        <span style="font-size: 0.85em; color: #666;">* í‘œê°€ ì•ˆ ë³´ì´ë©´ ìƒˆë¡œê³ ì¹¨(F5)ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>
    </div>

    <div id="spreadsheet"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

<script>
    // í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •
    window.onload = function() {
        const container = document.getElementById('spreadsheet');
        const statusEl = document.getElementById('save-status');
        let isChanged = false;

        const savedData = localStorage.getItem('my_research_v3');
        const defaultData = [
            ['í’ˆëª©ëª…', 'ìˆ˜ëŸ‰', 'ë‹¨ê°€', 'í•©ê³„', 'ë¹„ê³ '],
            ['ìƒ˜í”Œ', 0, 0, 0, ''],
            ['', '', '', '', ''],
            ['', '', '', '', ''],
            ['í•©ê³„', 0, 0, 0, '-'],
            ['í‰ê· ', 0, 0, 0, '-']
        ];
        
        const currentData = savedData ? JSON.parse(savedData) : defaultData;

        const hot = new Handsontable(container, {
            data: currentData,
            rowHeaders: true,
            colHeaders: true,
            height: '500px',
            width: '100%',
            licenseKey: 'non-commercial-and-evaluation',
            contextMenu: true,
            stretchH: 'all',
            renderAllRows: true, // í‘œê°€ ì•ˆ ë³´ì¼ ë•Œ í•´ê²°í•˜ëŠ” ì˜µì…˜
            cells: function(row, col) {
                const cellProperties = {};
                if (row >= this.instance.countRows() - 2) {
                    cellProperties.readOnly = true;
                    cellProperties.className = 'summary-row';
                }
                return cellProperties;
            },
            afterChange: function(changes, source) {
                if (source === 'loadData' || source === 'formulaUpdate') return;
                updateCalculations(this);
                isChanged = true;
                statusEl.innerText = "âš ï¸ ì €ì¥ ì•ˆ ë¨";
                statusEl.className = "status unsaved";
            }
        });

        function updateCalculations(instance) {
            const rowCount = instance.countRows();
            const dataRows = rowCount - 2;
            for (let col = 1; col <= 3; col++) {
                let sum = 0;
                let count = 0;
                for (let row = 0; row < dataRows; row++) {
                    let val = parseFloat(instance.getDataAtCell(row, col));
                    if (!isNaN(val)) { sum += val; count++; }
                }
                instance.setDataAtCell(rowCount - 2, col, sum, 'formulaUpdate');
                instance.setDataAtCell(rowCount - 1, col, count > 0 ? (sum / count).toFixed(1) : 0, 'formulaUpdate');
            }
        }

        window.saveToLocalStorage = function() {
            localStorage.setItem('my_research_v3', JSON.stringify(hot.getData()));
            isChanged = false;
            statusEl.innerText = "âœ… ì €ì¥ë¨";
            statusEl.className = "status saved";
        };

        window.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveToLocalStorage();
            }
        });
    };
</script>
</body>
</html>
